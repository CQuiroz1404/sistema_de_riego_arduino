# ๐ก Diagrama de Arquitectura MQTT

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SISTEMA DE RIEGO IoT - ARQUITECTURA MQTT             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                             CAPA DE PRESENTACIรN                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ   โ
โ   โ  ๐ Dashboard   โ    โ  ๐ Grรกficos    โ    โ  ๐๏ธ  Control    โ   โ
โ   โ   (Handlebars)  โ    โ   (Chart.js)    โ    โ   Actuadores    โ   โ
โ   โโโโโโโโโโฌโโโโโโโโโ    โโโโโโโโโโฌโโโโโโโโโ    โโโโโโโโโโฌโโโโโโโโโ   โ
โ            โ                      โ                       โ              โ
โ            โโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ                                   โ                                      โ
โ                           HTTP/AJAX Requests                             โ
โ                                   โ                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        CAPA DE APLICACIรN (Node.js)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ   โ                    Express.js Server (MVC)                       โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ   โ                                                                  โ   โ
โ   โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ         โ   โ
โ   โ  โ Controllers  โ  โ    Models    โ  โ    Views     โ         โ   โ
โ   โ  โ              โ  โ              โ  โ              โ         โ   โ
โ   โ  โ - Auth       โ  โ - Device     โ  โ - Dashboard  โ         โ   โ
โ   โ  โ - Dashboard  โ  โ - Sensor     โ  โ - Devices    โ         โ   โ
โ   โ  โ - Device     โ  โ - Actuator   โ  โ - Auth       โ         โ   โ
โ   โ  โ - Sensor     โ  โ - User       โ  โ              โ         โ   โ
โ   โ  โ - Arduino โจ โ  โ - Alert      โ  โ              โ         โ   โ
โ   โ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโโโโโโโโโ         โ   โ
โ   โ         โ                 โ                                     โ   โ
โ   โ         โ                 โ                                     โ   โ
โ   โ         โโโโโโโโโโฌโโโโโโโโโ                                     โ   โ
โ   โ                  โ                                              โ   โ
โ   โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                      โ                                                   โ
โ   โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ   โ              ๐ก MQTT SERVICE (mqttService.js)                  โ    โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค    โ
โ   โ                                                                 โ    โ
โ   โ  โ Conexiรณn al broker MQTT                                    โ    โ
โ   โ  โ Suscripciรณn a tรณpicos de dispositivos                      โ    โ
โ   โ  โ Procesamiento de datos de sensores                         โ    โ
โ   โ  โ Control de actuadores (pub/sub)                            โ    โ
โ   โ  โ Verificaciรณn automรกtica de riego                           โ    โ
โ   โ  โ Manejo de eventos y alertas                                โ    โ
โ   โ  โ Cachรฉ de dispositivos                                      โ    โ
โ   โ                                                                 โ    โ
โ   โ  Publicaciรณn (Servidor โ Arduino):                             โ    โ
โ   โ    โข riego/{API_KEY}/comandos                                  โ    โ
โ   โ    โข riego/{API_KEY}/comandos/all                              โ    โ
โ   โ                                                                 โ    โ
โ   โ  Suscripciรณn (Arduino โ Servidor):                             โ    โ
โ   โ    โข riego/{API_KEY}/sensores                                  โ    โ
โ   โ    โข riego/{API_KEY}/eventos                                   โ    โ
โ   โ    โข riego/{API_KEY}/ping                                      โ    โ
โ   โ                                                                 โ    โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                            โ                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                  โโโโโโโโโโโโดโโโโโโโโโโโ
                  โ   MQTT Protocol     โ
                  โ   (QoS 1, JSON)     โ
                  โโโโโโโโโโโโฌโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           MQTT BROKER (EMQX)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ   โ  ๐ Message Routing & Distribution                               โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ   โ                                                                  โ   โ
โ   โ  โข Topic-based routing                                          โ   โ
โ   โ  โข Quality of Service (QoS) garantizado                         โ   โ
โ   โ  โข Persistent connections                                       โ   โ
โ   โ  โข Low latency (<100ms)                                         โ   โ
โ   โ  โข Scalable to thousands of devices                             โ   โ
โ   โ                                                                  โ   โ
โ   โ  Tรณpicos activos:                                               โ   โ
โ   โ    โโ riego/device1_api_key/sensores                            โ   โ
โ   โ    โโ riego/device1_api_key/comandos                            โ   โ
โ   โ    โโ riego/device1_api_key/comandos/all                        โ   โ
โ   โ    โโ riego/device1_api_key/eventos                             โ   โ
โ   โ    โโ riego/device1_api_key/ping                                โ   โ
โ   โ                                                                  โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                  โโโโโโโโโโโโดโโโโโโโโโโโ
                  โ   MQTT Protocol     โ
                  โ   (WiFiS3 + PubSub) โ
                  โโโโโโโโโโโโฌโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       CAPA DE HARDWARE (Arduino)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ   โ             ๐ค Arduino UNO R4 WiFi (ESP32-S3)                    โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ   โ                                                                  โ   โ
โ   โ  Firmware: sistema_riego_mqtt.ino                               โ   โ
โ   โ                                                                  โ   โ
โ   โ  โโโโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโโโ            โ   โ
โ   โ  โ  ๐ก WiFiS3         โ      โ  ๐ก PubSubClient   โ            โ   โ
โ   โ  โ  (Connectivity)    โโโโโโโบโ  (MQTT Client)     โ            โ   โ
โ   โ  โโโโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโฌโโโโโโโโโโโโ            โ   โ
โ   โ                                       โ                         โ   โ
โ   โ                              โโโโโโโโโโดโโโโโโโโโโโโ             โ   โ
โ   โ                              โ  ArduinoJson       โ             โ   โ
โ   โ                              โ  (Serialization)   โ             โ   โ
โ   โ                              โโโโโโโโโโฌโโโโโโโโโโโโ             โ   โ
โ   โ                                       โ                         โ   โ
โ   โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโ  โ   โ
โ   โ  โ            Main Loop (Non-blocking)                       โ  โ   โ
โ   โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ   โ
โ   โ  โ                                                            โ  โ   โ
โ   โ  โ  1. client.loop()        โโโโ Procesa mensajes MQTT      โ  โ   โ
โ   โ  โ  2. Leer sensores (10s)  โโโโ Publica a /sensores        โ  โ   โ
โ   โ  โ  3. Enviar ping (30s)    โโโโ Publica a /ping            โ  โ   โ
โ   โ  โ  4. Escuchar comandos    โโโโ Callback MQTT              โ  โ   โ
โ   โ  โ  5. Actualizar actuadores โโโโ Controla pines            โ  โ   โ
โ   โ  โ                                                            โ  โ   โ
โ   โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ   โ
โ   โ                                                                  โ   โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ   โ   ๐ SENSORES             โ    โ   ๐๏ธ  ACTUADORES           โ       โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค       โ
โ   โ                           โ    โ                            โ       โ
โ   โ  โข Humedad Suelo (A0)     โ    โ  โข Bomba Riego (Pin 7)     โ       โ
โ   โ  โข Temperatura (DHT)      โ    โ  โข Vรกlvula 1 (Pin 8)       โ       โ
โ   โ  โข Nivel Agua (A1)        โ    โ  โข Vรกlvula 2 (Pin 9)       โ       โ
โ   โ  โข Luz (A2)               โ    โ                            โ       โ
โ   โ                           โ    โ                            โ       โ
โ   โ  Lectura cada 10s         โ    โ  Control en tiempo real    โ       โ
โ   โ  Publicaciรณn automรกtica   โ    โ  Respuesta < 100ms         โ       โ
โ   โ                           โ    โ                            โ       โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ                                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       CAPA DE PERSISTENCIA (MySQL)                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                  โ
โ   โ  dispositivosโ  โ   sensores   โ  โ  actuadores  โ                  โ
โ   โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค                  โ
โ   โ - id         โ  โ - id         โ  โ - id         โ                  โ
โ   โ - api_key    โ  โ - tipo       โ  โ - tipo       โ                  โ
โ   โ - nombre     โ  โ - pin        โ  โ - pin        โ                  โ
โ   โ - estado     โ  โ - valor_min  โ  โ - estado     โ                  โ
โ   โ - ultima_con โ  โ - valor_max  โ  โ              โ                  โ
โ   โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                  โ
โ                                                                           โ
โ   โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                  โ
โ   โ  lecturas    โ  โ    alertas   โ  โ   usuarios   โ                  โ
โ   โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค                  โ
โ   โ - sensor_id  โ  โ - tipo       โ  โ - id         โ                  โ
โ   โ - valor      โ  โ - severidad  โ  โ - email      โ                  โ
โ   โ - timestamp  โ  โ - mensaje    โ  โ - password   โ                  โ
โ   โ              โ  โ - leido      โ  โ - rol        โ                  โ
โ   โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                  โ
โ                                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         FLUJO DE DATOS EN TIEMPO REAL
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ PUBLICACIรN DE SENSORES (cada 10 segundos)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
Arduino                     MQTT Broker                   Node.js Server
   โ                             โ                              โ
   โ โ Leer sensores             โ                              โ
   โ (Humedad, Temp, etc)        โ                              โ
   โ                             โ                              โ
   โ โก Serializar JSON           โ                              โ
   โ {"sensores": [...]}         โ                              โ
   โ                             โ                              โ
   โ โข Publicar                  โ                              โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบ                              โ
   โ  PUBLISH                    โ                              โ
   โ  riego/API_KEY/sensores     โ                              โ
   โ  QoS 1                      โ                              โ
   โ                             โ                              โ
   โ                             โ โฃ Distribuir mensaje         โ
   โ                             โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบ
   โ                             โ  Tรณpico: riego/+/sensores    โ
   โ                             โ                              โ
   โ                             โ                              โ โค Callback
   โ                             โ                              โ handleMessage()
   โ                             โ                              โ
   โ                             โ                              โ โฅ Validar
   โ                             โ                              โ API_KEY
   โ                             โ                              โ
   โ                             โ                              โ โฆ Guardar BD
   โ                             โ                              โ Sensor.addReading()
   โ                             โ                              โ
   โ                             โ                              โ โง Verificar
   โ                             โ                              โ umbrales
   โ                             โ                              โ
   โ                             โ                              โ โจ Si procede:
   โ                             โ                              โ Activar riego


๐๏ธ  CONTROL DE ACTUADORES (tiempo real < 100ms)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
Usuario Web                Node.js Server          MQTT Broker        Arduino
   โ                             โ                       โ                โ
   โ โ Click "Encender Bomba"    โ                       โ                โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบ                       โ                โ
   โ  POST /api/arduino/control  โ                       โ                โ
   โ  {actuator_id: 1, ...}      โ                       โ                โ
   โ                             โ                       โ                โ
   โ                             โ โก Verificar permisos  โ                โ
   โ                             โ AuthController        โ                โ
   โ                             โ                       โ                โ
   โ                             โ โข Actualizar BD       โ                โ
   โ                             โ Actuator.updateState()โ                โ
   โ                             โ                       โ                โ
   โ                             โ โฃ Publicar comando    โ                โ
   โ                             โโโโโโโโโโโโโโโโโโโโโโโโโบ                โ
   โ                             โ  PUBLISH              โ                โ
   โ                             โ  riego/API_KEY/comandosโ                โ
   โ                             โ  {"actuador_id": 1,   โ                โ
   โ                             โ   "estado": 1}        โ                โ
   โ                             โ                       โ                โ
   โ โค Respuesta inmediata       โ                       โ โฅ Enrutar      โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                       โโโโโโโโโโโโโโโโโโบ
   โ {"success": true}           โ                       โ  a suscriptor  โ
   โ                             โ                       โ                โ
   โ                             โ                       โ                โ โฆ Callback
   โ                             โ                       โ                โ callbackMQTT()
   โ                             โ                       โ                โ
   โ                             โ                       โ                โ โง Parsear JSON
   โ                             โ                       โ                โ ArduinoJson
   โ                             โ                       โ                โ
   โ                             โ                       โ                โ โจ Actualizar pin
   โ                             โ                       โ                โ digitalWrite()
   โ                             โ                       โ                โ
   โ                             โ                       โ                โ ๐ก Bomba ON


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         VENTAJAS DE LA ARQUITECTURA
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ Baja Latencia:          Respuesta < 100ms vs 5-10s (HTTP polling)
โ Eficiencia:             Eventos en tiempo real, no polling constante
โ Escalabilidad:          Broker MQTT maneja miles de dispositivos
โ Bidireccional:          Comunicaciรณn nativa push/pull
โ Bajo Consumo:           Keep-alive ligero, ideal para IoT
โ Desacoplamiento:        Dispositivos no dependen de respuesta sรญncrona
โ QoS Garantizado:        Mensajes confirmados (QoS 1)
โ Resistente a Fallos:    Reconexiรณn automรกtica WiFi/MQTT

```
